<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>value generators - ABI Cafe</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><li class="part-title">ABI Cafe</li><li class="chapter-item expanded "><a href="../../intro.html"><strong aria-hidden="true">1.</strong> introduction</a></li><li class="chapter-item expanded "><a href="../../harness/combos.html"><strong aria-hidden="true">2.</strong> usage</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../harness/combos/tests.html"><strong aria-hidden="true">2.1.</strong> test files</a></li><li class="chapter-item expanded "><a href="../../harness/combos/conventions.html"><strong aria-hidden="true">2.2.</strong> calling conventions</a></li><li class="chapter-item expanded "><a href="../../harness/combos/reprs.html"><strong aria-hidden="true">2.3.</strong> type reprs</a></li><li class="chapter-item expanded "><a href="../../harness/combos/toolchains.html"><strong aria-hidden="true">2.4.</strong> toolchain pairings</a></li><li class="chapter-item expanded "><a href="../../harness/combos/values.html" class="active"><strong aria-hidden="true">2.5.</strong> value generators</a></li><li class="chapter-item expanded "><a href="../../harness/combos/selectors.html"><strong aria-hidden="true">2.6.</strong> value selectors</a></li><li class="chapter-item expanded "><a href="../../harness/combos/writers.html"><strong aria-hidden="true">2.7.</strong> value writers</a></li></ol></li><li class="chapter-item expanded "><a href="../../trophies.html"><strong aria-hidden="true">3.</strong> trophy case</a></li><li class="chapter-item expanded affix "><li class="part-title">KDLScript</li><li class="chapter-item expanded "><a href="../../kdl-script/index.html"><strong aria-hidden="true">4.</strong> introduction</a></li><li class="chapter-item expanded "><a href="../../kdl-script/attributes.html"><strong aria-hidden="true">5.</strong> attributes</a></li><li class="chapter-item expanded "><a href="../../kdl-script/functions/index.html"><strong aria-hidden="true">6.</strong> functions</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../kdl-script/functions/signatures.html"><strong aria-hidden="true">6.1.</strong> signatures</a></li><li class="chapter-item expanded "><a href="../../kdl-script/functions/bodies.html"><strong aria-hidden="true">6.2.</strong> bodies (lmao)</a></li></ol></li><li class="chapter-item expanded "><a href="../../kdl-script/types/index.html"><strong aria-hidden="true">7.</strong> types</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../kdl-script/types/primitives.html"><strong aria-hidden="true">7.1.</strong> primitives</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">7.2.</strong> nominal types</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../kdl-script/types/struct.html"><strong aria-hidden="true">7.2.1.</strong> struct</a></li><li class="chapter-item expanded "><a href="../../kdl-script/types/union.html"><strong aria-hidden="true">7.2.2.</strong> union</a></li><li class="chapter-item expanded "><a href="../../kdl-script/types/enum.html"><strong aria-hidden="true">7.2.3.</strong> enum</a></li><li class="chapter-item expanded "><a href="../../kdl-script/types/tagged.html"><strong aria-hidden="true">7.2.4.</strong> tagged</a></li><li class="chapter-item expanded "><a href="../../kdl-script/types/alias.html"><strong aria-hidden="true">7.2.5.</strong> alias</a></li><li class="chapter-item expanded "><a href="../../kdl-script/types/pun.html"><strong aria-hidden="true">7.2.6.</strong> pun</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">7.3.</strong> structural types</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../kdl-script/types/refs.html"><strong aria-hidden="true">7.3.1.</strong> references</a></li><li class="chapter-item expanded "><a href="../../kdl-script/types/arrays.html"><strong aria-hidden="true">7.3.2.</strong> arrays</a></li><li class="chapter-item expanded "><a href="../../kdl-script/types/tuples.html"><strong aria-hidden="true">7.3.3.</strong> tuples</a></li></ol></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">ABI Cafe</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/Gankra/abi-cafe" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/Gankra/abi-cafe/edit/main/docs/src/harness/combos/values.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="value-generators"><a class="header" href="#value-generators">value generators</a></h1>
<p>When generating the source for a program to test, we need to pick values which will be passed to all the functions. These values are baked into the program, with both sides statically knowing which values they <em>should</em> have, and the test harness also having that information available for checking and diagnostics.</p>
<p>As later sections will explain, this system also allows us to do magic like "generate only the necessary branches of match statements", "generate random-depthed values of self-referential types", "derive debug on c-like untagged unions", and "compare the values of type puns with different fields".</p>
<h2 id="--gen-vals"><a class="header" href="#--gen-vals"><code>--gen-vals</code></a></h2>
<p>By default we only set <code>--gen-vals=graffiti</code>, as this mode produces the most useful diagnostic information.</p>
<p>The possible values are</p>
<ul>
<li>graffiti: prefers patterning the bytes of values in a way that helps you identify which byte of which field each recorded value was.</li>
<li>randomN (random1, random37, ...): seeds an RNG with N to make random (repeatable) values with</li>
</ul>
<h2 id="graffiti-values"><a class="header" href="#graffiti-values">graffiti values</a></h2>
<p>The grafitti pattern stores two indices in each byte: the high nibble contains the index of the field that the byte belongs to (mod 16), and the low nibble contains the index of the byte (mod 16).</p>
<p>For instance graffiti values should look something like:</p>
<pre><code class="language-rust  ignore">let array_of_points = [
    Point { x: 0x0102_0304, y: 0x1112_1314 },
    Point { x: 0x2122_2324, y: 0x3132_3334 },
]
let bytes = [0x40, 0x50, 0x60, 0x70];

some_func(array_of_points, bytes);</code></pre>
<p>The benefit of this system is that when there's an ABI mismatch if you see something like:</p>
<pre><code class="language-text">mismatch in some_func val 2 (array_of_points[1].x: u32)
expect: [21, 22, 23, 24]
caller: [21, 22, 23, 24]
callee: [23, 24, 31, 32]
</code></pre>
<p>You can pretty clearly see that the callee got half its bytes from val 2, and half of its bytes from val 3, indicating some kind of alignment/padding disagreement.</p>
<h2 id="the-value-tree"><a class="header" href="#the-value-tree">The Value Tree</a></h2>
<p>The value tree is the solution that was created to address the various problems sketched out <a href="https://faultlore.com/blah/abi-puns/#what-does-it-mean-for-compilers-to-agree">in this article on ABI Cafe</a>.</p>
<h3 id="value-tree-problem-statement"><a class="header" href="#value-tree-problem-statement">Value Tree Problem Statement</a></h3>
<p>There are several problems we need ABI Cafe to solve regarding values:</p>
<ul>
<li>We need to be able to pick values for fields in a deterministic/repeatable way so we can reliably reproduce any issues found</li>
<li>We would like the test harness to know what values the programs <em>should</em> have when checking them (at very least to produce better diagnostics)</li>
<li>Given a type with "cases" like a tagged union, untagged union, or c-like enum, we need to be able to pick the case it should have, and deal with the fact that this changes the number/names of the fields</li>
<li>If we want to report the values of an untagged union, we find ourselves needing to <code>derive(Debug)</code> on an untagged union, which is impossible (nothing in the value itself specifies its case)</li>
<li>Self-referential types may have an arbitrary number of values (like a linked list)</li>
<li>Type puns may introduce completely different shapes/paths for the same logical values (<code>(u32, u32)</code> vs <code>[u32; 2]</code>)</li>
</ul>
<p>The value tree is able to handle all these cases!</p>
<h3 id="value-tree-solution"><a class="header" href="#value-tree-solution">Value Tree Solution</a></h3>
<p>Essentially the key insight here is that no matter how complicated a type is, an <em>instance</em> of that type has a tree structure (which syntax like <code>x.y[2].3</code> is a path on). A <em>traversal</em> of that tree then gives a linear list of (paths to) fields and types, for which we need to generate values.</p>
<p>(Note: intrusive values which contain pointers to themselves <em>aren't</em> treelike, but we simply don't support those because they aren't interesting to us. When we refer to self-referential types, we're talking about types which can contain <em>other instances</em> of the same type, and not literally the same instance.)</p>
<p>When traversing a struct, there isn't anything special to do: we can just recursively traverse each of its fields. When traversing a tagged or untagged union we apply a simple trick: we introduce an additional artificial leaf field representing the case (tag) of the union.</p>
<p>Since we're already assuming we have a way to deterministically generate pseudorandom values, this gives us a way to uniformly select one of the cases of the union for each instance of the type. This also naturally handles all valid self-referential types, because they inevitably need to contain something that looks like <code>Option&lt;Self&gt;</code>. Each time we encounter that Option, we are essentially flipping a coin as to whether we should add another layer of Self, or finish.</p>
<p>These artificial tag fields also give us a way to "derive(Debug) on an untagged union" -- because we're emitting the print statements totally inline for each instance, the code generator can consult the value tree for which case each union has, and only emit the code for accessing that case.</p>
<p>This ends up being nice even for tagged unions, because it lets us emit only a minimal <code>if let</code> instead of a full <code>match</code>. We even get an internal entry for "which case, semantically, did the program think the tagged union was in", which the program can use to report back that information back to to the harness (as a u32 value, reporting u32::MAX in the <code>else</code> branch of the if-let to indicate "not the one we expected").</p>
<p>Also, we don't actually care about any of the internal fields, we only care about the leaf (primitive) fields, which have actual logical bytes we can inspect and compare (or the cases of our unions). So, as long as two value tree traversals produce lists with the same lengths, we can compare them, allowing us to handle puns like <code>(u32, u32)</code> vs <code>[u32; 2]</code> or even more complex cases readily.</p>
<h3 id="value-tree-compromises"><a class="header" href="#value-tree-compromises">Value Tree Compromises</a></h3>
<p>The only kind of pun we really can't handle is one like <code>u64</code> vs <code>(u32, u32)</code>, because the counts desync. In the current implementation when traversing <a href="../../kdl-script/types/pun.html">a pun</a>, we assert that all blocks of the pun produce the same length list. This is a bit sad, but honestly, that was always going to be a semantic nightmare.</p>
<p>For various reasons it's tempting to want to "statically" number the leaf fields, such that <code>x.y[2].3</code> can be referred to by a stable index, regardless of the value generation strategy. This is theoretically possible even with unions, because you can traverse even the cases that aren't selected and still number them.</p>
<p>However the notion of a static numbering completely falls apart once you introduce self-referential types, as there is no static bound on the size of a self-referential subtree (and trying to artifically bound it is more work than it's worth). I also vaguely recall this completely breaking my brain to think about in the context of type puns, so, no big loss. We can just make value numbering value-generation-scoped, and get much the same benefit.</p>
<p>The same logic that allows for type puns to be handled would also allow <a href="https://github.com/Gankra/abi-cafe/issues/47">function puns</a> to be handled (<code>fn(x: u32, y: u32)</code> vs <code>fn(point: (u32, u32))</code>). We currently don't allow for this, in an attempt to make diagnostics better. <a href="https://github.com/Gankra/abi-cafe/issues/53">In the future we might lift this restriction.</a></p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../harness/combos/toolchains.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../harness/combos/selectors.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../harness/combos/toolchains.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../harness/combos/selectors.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
